<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Jetton Minter — Wallet Connect (TonConnect)</title>
<style>
:root{--bg:#000;--fg:#fff;--muted:#bdbdbd}
body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--fg)}
.container{max-width:980px;margin:28px auto;padding:20px}
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
header h1{font-size:20px;margin:0}
.btn{background:#fff;color:#000;padding:10px 14px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
.small{font-size:12px;color:var(--muted)}
.card{background:linear-gradient(180deg,#0b0b0b,#070707);border:1px solid #222;padding:18px;border-radius:12px;margin-bottom:14px}
.row{display:flex;gap:10px;align-items:center}
.logo-preview{width:100px;height:100px;border:1px dashed #222;border-radius:8px;display:flex;align-items:center;justify-content:center}
pre{white-space:pre-wrap;color:var(--muted);font-size:13px}
footer{margin-top:18px;font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Jetton Minter — Connect Wallet</h1>
    <div class="row">
      <button id="connectBtn" class="btn">Connect Wallet</button>
      <button id="disconnectBtn" class="btn" style="display:none">Disconnect</button>
    </div>
  </header>

  <div class="card">
    <div style="display:flex;gap:18px">
      <div style="flex:1">
        <div class="small">Connected wallet</div>
        <div id="walletInfo" class="small">Not connected</div>
        <div style="margin-top:12px">
          <div class="small">Quick deploy (paste compiled stateInit base64)</div>
          <textarea id="stateInit" rows="4" style="width:100%;background:#070707;color:var(--fg);border:1px solid #222;border-radius:8px;padding:8px" placeholder="PASTE compiled stateInit (base64) here"></textarea>
          <div style="margin-top:10px">
            <input id="deployAmount" type="text" placeholder="Fee amount (nanotons) e.g. 50000000" style="padding:8px;border-radius:8px;border:1px solid #222;background:#070707;color:var(--fg);width:260px" />
            <button id="deployBtn" class="btn">Send Deploy Tx</button>
          </div>
        </div>
      </div>

      <div style="width:220px">
        <div class="small">Preview Logo</div>
        <div class="logo-preview" id="logoPreview">—</div>
        <div style="margin-top:12px">
          <div class="small">Log</div>
          <pre id="log">No actions yet.</pre>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <div class="small">Make sure you added <code>tonconnect-manifest.json</code> at site root (see instructions).</div>
  </footer>
</div>

<!-- TonConnect UMD bundle (pinned version). Using UMD so you can paste directly to GitHub Pages -->
<script src="https://unpkg.com/@tonconnect/sdk@0.6.4/dist/tonconnect.umd.js"></script>

<script>
/*
  Robust TonConnect front-end
  - Uses UMD bundle loaded above
  - Exposes connect / restore / disconnect
  - sendDeployTx(stateInitBase64, amountNano) helper to open wallet and send deploy
  NOTES:
  - Place tonconnect-manifest.json at your site root (example provided below)
  - Use Tonkeeper (Testnet) app to scan QR or open the universal link
*/

(async function(){
  const connectBtn = document.getElementById('connectBtn');
  const disconnectBtn = document.getElementById('disconnectBtn');
  const walletInfo = document.getElementById('walletInfo');
  const logEl = document.getElementById('log');
  const stateInitEl = document.getElementById('stateInit');
  const deployBtn = document.getElementById('deployBtn');
  const deployAmountEl = document.getElementById('deployAmount');
  const logoPreview = document.getElementById('logoPreview');

  function appendLog(s){
    logEl.textContent = new Date().toLocaleTimeString() + ' — ' + s + '\\n' + logEl.textContent;
  }

  // find TonConnect constructor in UMD
  const TonConnectConstructor = window.TonConnect || window.tonconnect?.TonConnect || (window.tonconnect && window.tonconnect.TonConnect) || null;
  if (!TonConnectConstructor) {
    appendLog('ERROR: TonConnect SDK not found. Check script include.');
    return;
  }

  // init with manifest
  const manifestUrl = location.origin + '/tonconnect-manifest.json';
  let tonConnect;
  try {
    tonConnect = new TonConnectConstructor({ manifestUrl });
  } catch (e) {
    appendLog('TonConnect init error: ' + (e?.message || e));
    return;
  }

  // try restore prior session
  try {
    if (typeof tonConnect.restoreConnection === 'function') {
      await tonConnect.restoreConnection();
      if (tonConnect.connected) {
        onConnected();
        appendLog('Restored connection.');
      } else {
        appendLog('No previous connection to restore.');
      }
    } else {
      appendLog('restoreConnection() not available on this SDK version; proceed manually.');
    }
  } catch (e) {
    appendLog('restoreConnection error: ' + (e?.message || e));
  }

  // connect button
  connectBtn.addEventListener('click', async () => {
    try {
      // TonConnect.connect() opens the wallet selection UI (or QR) and returns when user approves or cancels.
      await tonConnect.connect();
      if (tonConnect.connected) {
        onConnected();
        appendLog('Connected via TonConnect.');
      } else {
        appendLog('User canceled connect or connection not established.');
      }
    } catch (err) {
      appendLog('Connect error: ' + (err?.message || err));
    }
  });

  // disconnect button
  disconnectBtn.addEventListener('click', async () => {
    try {
      if (typeof tonConnect.disconnect === 'function') {
        await tonConnect.disconnect();
      }
      walletInfo.textContent = 'Not connected';
      connectBtn.style.display = '';
      disconnectBtn.style.display = 'none';
      appendLog('Disconnected.');
    } catch (e) {
      appendLog('Disconnect error: ' + (e?.message || e));
    }
  });

  function onConnected(){
    // many SDK versions store account on tonConnect.account or tonConnect.connectedAccount
    const addr = (tonConnect.account && tonConnect.account.address) || (tonConnect.connected && tonConnect.connected.account && tonConnect.connected.account.address) || null;
    walletInfo.textContent = addr ? addr + ' (connected)' : 'Connected (address unknown)';
    connectBtn.style.display = 'none';
    disconnectBtn.style.display = '';
  }

  // helper to send deploy transaction using stateInit
  async function sendDeployTx(stateInitB64, amountNano) {
    if (!tonConnect.connected) {
      appendLog('Not connected — cannot send tx.');
      throw new Error('not connected');
    }
    if (!stateInitB64) {
      appendLog('Missing stateInit. Paste compiled base64 into textarea.');
      throw new Error('missing stateInit');
    }
    const validUntil = Date.now() + 1000 * 60 * 10;
    const message = {
      validUntil,
      messages: [
        {
          amount: String(amountNano || '50000000'), // default 0.05 TON (nanotons)
          stateInit: stateInitB64
        }
      ]
    };

    appendLog('Opening wallet to sign deploy transaction...');
    try {
      // use sendTransaction if available
      if (typeof tonConnect.sendTransaction === 'function') {
        const res = await tonConnect.sendTransaction(message);
        appendLog('Transaction submitted (sendTransaction): ' + JSON.stringify(res));
        return res;
      }
      // fallback to ui.sendTransaction if present
      if (tonConnect.ui && typeof tonConnect.ui.sendTransaction === 'function') {
        const res = await tonConnect.ui.sendTransaction(message);
        appendLog('Transaction submitted (ui.sendTransaction): ' + JSON.stringify(res));
        return res;
      }

      // Some SDK versions might expect a different API; print helpful error
      appendLog('ERROR: sendTransaction API not found on TonConnect instance. SDK mismatch.');
      throw new Error('sendTransaction not found');
    } catch (err) {
      appendLog('Transaction error / cancelled: ' + (err?.message || err));
      throw err;
    }
  }

  // deploy button action
  deployBtn.addEventListener('click', async () => {
    const stateInit = stateInitEl.value.trim();
    const amountStr = (deployAmountEl.value || '').trim();
    const amountNano = amountStr || '50000000';
    try {
      await sendDeployTx(stateInit, amountNano);
      appendLog('Deploy request sent to wallet. Wait for block confirmation in block explorer.');
    } catch (e) {
      // errors have already been logged
    }
  });

  // quick preview for logo if someone pastes metadata URL
  stateInitEl.addEventListener('input', () => {
    // no-op by default; you can implement base64 to parse metadata if you want
  });

  appendLog('TonConnect UI ready. Manifest: ' + manifestUrl);
})();
</script>
</body>
</html>
